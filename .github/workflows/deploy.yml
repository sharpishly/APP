- name: Deploy with SSH and pull latest code
  uses: appleboy/ssh-action@v1.0.0
  with:
    host: ${{ secrets.SSH_HOST }}
    username: ${{ secrets.SSH_USERNAME }}
    key: ${{ secrets.SSH_KEY }}
    script: |
      cd /var/www/app

      # Make safe before pulling new code
      git stash

      # Pull latest main repository changes
      git pull origin master

      # Ensure submodules are initialized
      git submodule update --init --recursive

      # Force submodules to pull latest changes from remote
      git submodule foreach 'git checkout master || git checkout main'
      git submodule foreach 'git pull origin $(git branch --show-current)'

      # Re-sync submodules recursively after pulling
      git submodule update --recursive

      # Allow access through firewall
      sudo ufw allow 80
      sudo ufw allow 443
      sudo ufw allow 8080
      sudo ufw allow 8443
      sudo ufw allow 1000
      sudo ufw allow 2000
      sudo ufw status

      # Set file and folder permissions
      sudo chmod -R 755 /var/www/app/sharpishly.com/website/public
      sudo chmod -R 755 /var/www/app/dev.sharpishly.com/website/public
      sudo chown -R www-data:www-data /var/www/app/sharpishly.com/website/public
      sudo chown -R www-data:www-data /var/www/app/dev.sharpishly.com/website/public
      sudo chmod -R 755 /var/www/app/python_project
      sudo chown -R www-data:www-data /var/www/app/python_project
      sudo chmod -R 755 /var/www/app/node_project
      sudo chown -R www-data:www-data /var/www/app/node_project
      sudo chmod -R 755 /var/www/app/letsencrypt
      sudo chown -R root:root /var/www/app/letsencrypt
      sudo chmod -R 755 /etc/letsencrypt
      sudo chown -R www-data:www-data /etc/letsencrypt

      # Restart Docker
      docker-compose down
      docker-compose up -d --build
